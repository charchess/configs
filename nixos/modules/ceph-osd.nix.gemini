{ config, pkgs, lib, ... }:

with lib;

let
  hostname = config.networking.hostName;
  cfg = config.services.cephExtra;
  disk = cfg.disk or "";
  osdId = cfg.osdId or 0;
in
{
  imports = [ ./ceph-options.nix ];
  config = mkIf (disk != "") {
    systemd.services."ceph-osd-${hostname}" = {
      description = "Ceph OSD ${hostname}";
      wantedBy = [ "multi-user.target" ];
      serviceConfig = {
        Type = "oneshot";
        RemainAfterExit = true;
        User = "ceph";
        Group = "ceph";
        ExecStart = "${pkgs.writeShellScript "ceph-osd-${hostname}" ''
          set -e
          if ! ${pkgs.ceph}/bin/ceph osd tree | grep -q osd.${toString osdId}; then
            ${pkgs.ceph}/bin/ceph-volume lvm create --data ${disk} --osd-id ${toString osdId} --no-systemd
          fi
        ''}";
      };
    };
  };
}