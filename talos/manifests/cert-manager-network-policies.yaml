# Fichier: manifests/cert-manager-network-policies.yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-cert-manager-critical-traffic
  namespace: cert-manager
spec:
  # Appliquer cette politique à tous les pods du namespace cert-manager
  endpointSelector: {}
  # Autoriser le trafic sortant (egress)
  egress:
  # Vers le service ClusterIP de l'API Server (essentiel)
  - toServices:
    - k8sService:
        serviceName: kubernetes
        namespace: default
  # Vers CoreDNS pour la résolution DNS (essentiel)
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
  # Au sein du namespace pour que les composants puissent se parler
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": cert-manager